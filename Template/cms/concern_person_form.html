<!-- templates/cms/concern_person_form.html -->
{% extends "bootstrap/vertical_base.html" %}

{% load humanize %}

{% load custom_filters %}

{% load crispy_forms_tags %}

{% load static %}

{% block extra_css %}
<!-- Select2 css -->
<link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Daterangepicker css -->
<link href="{% static 'css/vendor/daterangepicker.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Touchspin css -->
<link href="{% static 'css/vendor/jquery.bootstrap-touchspin.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Flatpickr Timepicker css -->
<link href="{% static 'css/vendor/flatpickr.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Datepicker css -->
<link href="{% static 'css/vendor/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Timepicker css -->
<link href="{% static 'css/vendor/bootstrap-timepicker.min.css' %}" rel="stylesheet" type="text/css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link href="{% static 'css/inputs.css' %}" rel="stylesheet" type="text/css" >

<!-- Selectize.js CSS -->
<link href="{% static 'css/selectize.min.css' %}" rel="stylesheet" type="text/css" >
<link href="{% static 'css/form_builder.css' %}" rel="stylesheet" type="text/css" >
<link href="{% static 'css/mtp.css' %}" rel="stylesheet" type="text/css" >

<style>
    .contact-info-section {
        background: var(--bs-light-bg-subtle);
        border-radius: 0.375rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        border-left: 4px solid var(--bs-info);
    }
    
    .concern-categories {
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--bs-border-color);
        border-radius: 0.375rem;
        padding: 1rem;
    }
</style>
{% endblock %}
{% block title %} Concern Person {% endblock %}

{% block content %}
<!-- Header Row -->
    <div class="row">
        <div class="col">
            <h4><i class="bi bi-file-earmark-text"></i> Concern Person</h4>
        </div>
        <div class="col-auto mt-2">
            <div class="btn-group mb-2">
                {% if customer %}
                <a href="{% url 'cms:customer_detail' pk=customer.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to Customer
                </a>
                {% else %}
                <a href="{% url 'cms:concern_person_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>
                {% endif %}
            </div>
        </div>
    </div>
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-person-badge me-2"></i>{{ title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="concernPersonForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <!-- Customer and Branch Selection -->
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.customer.id_for_label }}" class="form-label required-field">Customer</label>
                            {{ form.customer }}
                            {% if form.customer.errors %}
                            <div class="invalid-feedback d-block">{{ form.customer.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.branch_category.id_for_label }}" class="form-label">Branch Category</label>
                            {{ form.branch_category }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">Specific Address</label>
                            {{ form.address }}
                            <div class="form-text">Select a specific address (optional)</div>
                        </div>
                    </div>

                    <hr class="my-4">

                    <!-- Personal Information -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.concern_person.id_for_label }}" class="form-label required-field">Concern Person Name</label>
                            {{ form.concern_person }}
                            {% if form.concern_person.errors %}
                            <div class="invalid-feedback d-block">{{ form.concern_person.errors.0 }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.designation.id_for_label }}" class="form-label">Designation</label>
                            {{ form.designation }}
                        </div>
                    </div>

                    <!-- Concern Categories -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <label class="form-label">Concern For (Areas of Responsibility)</label>
                            <div class="concern-categories">
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="selectAllConcerns">
                                    <label class="form-check-label fw-bold" for="selectAllConcerns">Select All</label>
                                </div>
                                <hr>
                                <div class="row">
                                    {% for concern in form.concern_for %}
                                    <div class="col-md-6 col-lg-4 mb-2">
                                        <div class="form-check">
                                            {{ concern.tag }}
                                            <label class="form-check-label" for="{{ concern.id_for_label }}">
                                                {{ concern.choice_label }}
                                            </label>
                                        </div>
                                    </div>
                                    {% empty %}
                                    <div class="col-12">
                                        <p class="text-muted">No concern categories available. Please add some in the admin.</p>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="contact-info-section">
                        <h6 class="section-title mb-3">
                            <i class="bi bi-telephone me-2"></i>Contact Information
                        </h6>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label required-field">Primary Mobile</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <label class="form-label">Country</label>
                                        {{ form.country_1 }}
                                    </div>
                                    <div class="col-8">
                                        <label class="form-label">Mobile Number</label>
                                        {{ form.mobile_1 }}
                                        {% if form.mobile_1.errors %}
                                        <div class="invalid-feedback d-block">{{ form.mobile_1.errors.0 }}</div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Secondary Mobile</label>
                                <div class="row g-2">
                                    <div class="col-4">
                                        <label class="form-label">Country</label>
                                        {{ form.country_2 }}
                                    </div>
                                    <div class="col-8">
                                        <label class="form-label">Mobile Number</label>
                                        {{ form.mobile_2 }}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.office_phone_1.id_for_label }}" class="form-label">Office Phone 1</label>
                                {{ form.office_phone_1 }}
                            </div>
                            <div class="col-md-2 mb-3">
                                <label for="{{ form.office_extension_1.id_for_label }}" class="form-label">Extension</label>
                                {{ form.office_extension_1 }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.office_phone_2.id_for_label }}" class="form-label">Office Phone 2</label>
                                {{ form.office_phone_2 }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email_company.id_for_label }}" class="form-label">Company Email</label>
                                {{ form.email_company }}
                                {% if form.email_company.errors %}
                                <div class="invalid-feedback d-block">{{ form.email_company.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.email_personal.id_for_label }}" class="form-label">Personal Email</label>
                                {{ form.email_personal }}
                                {% if form.email_personal.errors %}
                                <div class="invalid-feedback d-block">{{ form.email_personal.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information -->
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="{{ form.remarks.id_for_label }}" class="form-label">Remarks</label>
                            {{ form.remarks }}
                            <div class="form-text">Any additional information about this concern person</div>
                        </div>
                    </div>

                    <!-- Status -->
                    <div class="row">
                        <div class="col-12">
                            <div class="form-check form-switch">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    Active Concern Person
                                </label>
                            </div>
                            <div class="form-check form-switch mt-2">
                                {{ form.is_primary_contact }}
                                <label class="form-check-label" for="{{ form.is_primary_contact.id_for_label }}">
                                    Primary Contact for Customer
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex gap-2 justify-content-end">
                                <button type="reset" class="btn btn-secondary">
                                    <i class="bi bi-arrow-clockwise me-1"></i>Reset
                                </button>
                                <button type="submit" class="btn btn-primary">
                                    <i class="bi bi-check-circle me-1"></i>
                                    {% if concern_person %}Update{% else %}Create{% endif %} Concern Person
                                </button>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'jquery/dist/jquery.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

{% if messages %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      {% for message in messages %}
        Swal.fire({
          title: "{{ message.tags|title }}",
          text: "{{ message|escapejs }}",
          icon: "{{ message.tags }}", // valid: success, error, warning, info, question
          confirmButtonText: "OK",
          background: theme === 'dark' ? '#343a40' : '#ffffff',
          color: theme === 'dark' ? '#f8f9fa' : '#212529',
          confirmButtonColor: theme === 'dark' ? '#0d6efd' : '#0d6efd',
          customClass: {
            popup: 'rounded-4 shadow',
            confirmButton: 'btn btn-primary px-4 py-2'
          }
        });
      {% endfor %}
    });
  </script>
{% endif %}

<script>
    // Select all concerns
    document.getElementById('selectAllConcerns').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="concern_for"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });

    // Dynamic address loading based on customer and branch category
    const customerSelect = document.getElementById('{{ form.customer.id_for_label }}');
    const branchCategorySelect = document.getElementById('{{ form.branch_category.id_for_label }}');
    const addressSelect = document.getElementById('{{ form.address.id_for_label }}');

    function loadAddresses() {
        const customerId = customerSelect.value;
        const branchCategory = branchCategorySelect.value;
        
        if (customerId) {
            let url = `{% url 'cms:get_customer_addresses' 0 %}`.replace('0', customerId);
            if (branchCategory) {
                url += `?branch_category=${branchCategory}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    addressSelect.innerHTML = data.addresses;
                });
        }
    }

    if (customerSelect) {
        customerSelect.addEventListener('change', loadAddresses);
    }
    if (branchCategorySelect) {
        branchCategorySelect.addEventListener('change', loadAddresses);
    }

    // Mobile number validation
    document.getElementById('{{ form.mobile_1.id_for_label }}').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);
    });

    document.getElementById('{{ form.mobile_2.id_for_label }}').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '').slice(0, 10);
    });

    // Office phone validation
    document.getElementById('{{ form.office_phone_1.id_for_label }}').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    document.getElementById('{{ form.office_phone_2.id_for_label }}').addEventListener('input', function(e) {
        this.value = this.value.replace(/[^0-9]/g, '');
    });

    // Initialize addresses if customer is pre-selected
    {% if customer %}
    loadAddresses();
    {% endif %}
</script>
{% endblock %}


{% block extra_javascript %}

{% include "bootstrap/partials/syntax-highlight.html" %}

<!-- Third party js -->
<script src="{% static 'js/vendor/handlebars.min.js' %}"></script>
<script src="{% static 'js/vendor/typeahead.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap-timepicker.min.js' %}"></script>
<!-- Third party js ends -->

<script src="{% static 'js/vendor/flatpickr.min.js' %}"></script>

<!-- Init js -->
<script src="{% static 'js/pages/demo.typehead.js' %}"></script>
<script src="{% static 'js/pages/demo.timepicker.js' %}"></script>
<!-- Init js end -->

<!-- Selectize.js JS -->
<script src="{% static 'js/selectize.min.js' %}"></script>
<script src="{% static 'js/vendor/select2.min.js' %}"></script>
{% endblock %}