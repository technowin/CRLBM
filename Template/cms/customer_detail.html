<!-- templates/cms/customer_detail.html -->
{% extends "bootstrap/vertical_base.html" %}

{% load humanize %}

{% load custom_filters %}

{% load crispy_forms_tags %}

{% load static %}

{% block extra_css %}
<!-- Select2 css -->
<link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Daterangepicker css -->
<link href="{% static 'css/vendor/daterangepicker.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Touchspin css -->
<link href="{% static 'css/vendor/jquery.bootstrap-touchspin.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Flatpickr Timepicker css -->
<link href="{% static 'css/vendor/flatpickr.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Datepicker css -->
<link href="{% static 'css/vendor/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Timepicker css -->
<link href="{% static 'css/vendor/bootstrap-timepicker.min.css' %}" rel="stylesheet" type="text/css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link href="{% static 'css/inputs.css' %}" rel="stylesheet" type="text/css" >

<!-- Selectize.js CSS -->
<link href="{% static 'css/selectize.min.css' %}" rel="stylesheet" type="text/css" >
<link href="{% static 'css/form_builder.css' %}" rel="stylesheet" type="text/css" >
<link href="{% static 'css/mtp.css' %}" rel="stylesheet" type="text/css" >

{% endblock %}
{% block title %} Customer Details {% endblock %}

{% block content %}

<!-- Header Row -->
    <div class="row">
        <div class="col">
            <h4><i class="bi bi-file-earmark-text"></i> Customer Details </h4>
        </div>
        <div class="col-auto mt-2">
            <div class="btn-group mb-2">
                <a href="{% url 'cms:customer_list' %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-1"></i>Back to List
                </a>&nbsp;&nbsp;&nbsp;
                <a href="{% url 'cms:customer_update' pk=customer.pk %}" class="btn btn-primary">
                    <i class="bi bi-pencil me-1"></i>Edit Customer
                </a>&nbsp;&nbsp;&nbsp;
                <a href="{% url 'cms:concern_person_create_for_customer' customer_pk=customer.pk %}" class="btn btn-primary">
                    <i class="bi bi-person-plus me-1"></i>Add Concern Person
                </a>
            </div>
        </div>
    </div>

<div class="row">
    <div class="col-12">
        <!-- Customer Basic Info Card -->
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="bi bi-building me-2"></i>{{ customer.name }}
                    <span class="badge bg-{% if customer.is_active %}success{% else %}danger{% endif %} ms-2">
                        {{ customer.get_status_display }}
                    </span>
                </h5>
                <div class="text-muted">Customer ID: {{ customer.customer_id }}</div>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 40%;">Organization Type:</th>
                                <td>{{ customer.organization_type }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">PAN Number:</th>
                                <td>{{ customer.pan_number }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Date of Establishment:</th>
                                <td>{{ customer.date_of_establishment|default:"Not specified" }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Payment Terms:</th>
                                <td>{{ customer.get_payment_terms_display }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm table-borderless">
                            <tr>
                                <th class="text-muted" style="width: 40%;">Credit Limit:</th>
                                <td>₹{{ customer.credit_limit }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Available Credit:</th>
                                <td>₹{{ customer.available_credit }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Billing Currency:</th>
                                <td>{{ customer.get_billing_currency_display }}</td>
                            </tr>
                            <tr>
                                <th class="text-muted">Website:</th>
                                <td>
                                    {% if customer.website %}
                                    <a href="{{ customer.website }}" target="_blank">{{ customer.website }}</a>
                                    {% else %}Not specified{% endif %}
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
                
                <!-- Additional Information -->
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="d-flex flex-wrap gap-3">
                            <div class="badge bg-light text-dark">
                                <i class="bi bi-people me-1"></i>
                                {{ customer.total_concern_persons }} Concern Persons
                            </div>
                            <div class="badge bg-light text-dark">
                                <i class="bi bi-geo-alt me-1"></i>
                                {{ addresses.count }} Addresses
                            </div>
                            <div class="badge bg-light text-dark">
                                <i class="bi bi-bank me-1"></i>
                                {{ bank_details.count }} Bank Accounts
                            </div>
                            {% if customer.requires_advance %}
                            <div class="badge bg-warning text-dark">
                                <i class="bi bi-exclamation-triangle me-1"></i>
                                Requires Advance
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs for Detailed Information -->
        <ul class="nav nav-pills bg-nav-pills nav-justified" id="customerDetailTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="concern-persons-tab" data-bs-toggle="tab" 
                        data-bs-target="#concern-persons" type="button" role="tab">
                    <i class="bi bi-people me-1"></i>Concern Persons
                    <span class="badge bg-success ms-1">{{ concern_persons.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="addresses-tab" data-bs-toggle="tab" 
                        data-bs-target="#addresses" type="button" role="tab">
                    <i class="bi bi-geo-alt me-1"></i>Addresses
                    <span class="badge bg-success ms-1">{{ addresses.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="bank-details-tab" data-bs-toggle="tab" 
                        data-bs-target="#bank-details" type="button" role="tab">
                    <i class="bi bi-bank me-1"></i>Bank Details
                    <span class="badge bg-success ms-1">{{ bank_details.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="documents-tab" data-bs-toggle="tab" 
                        data-bs-target="#documents" type="button" role="tab">
                    <i class="bi bi-folder me-1"></i>Documents
                    <span class="badge bg-success ms-1">{{ documents.count }}</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notes-tab" data-bs-toggle="tab" 
                        data-bs-target="#notes" type="button" role="tab">
                    <i class="bi bi-sticky me-1"></i>Notes
                    <span class="badge bg-success ms-1">{{ notes.count }}</span>
                </button>
            </li>
        </ul>

        <div class="tab-content" id="customerDetailTabsContent">
            <!-- Concern Persons Tab -->
            <div class="tab-pane fade show active" id="concern-persons" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Concern Persons</h4>
                        <div>
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#quickConcernModal">
                                <i class="bi bi-person-plus me-1"></i>Quick Add
                            </button>
                            <a href="{% url 'cms:concern_person_create_for_customer' customer_pk=customer.pk %}" class="btn btn-primary btn-sm">
                                <i class="bi bi-plus-circle me-1"></i>Add Full
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if concern_persons %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Designation</th>
                                        <th>Primary Mobile</th>
                                        <th>Company Email</th>
                                        <th>Concern For</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for person in concern_persons %}
                                    <tr>
                                        <td>
                                            <strong>{{ person.concern_person }}</strong>
                                            {% if person.is_primary_contact %}
                                            <span class="badge bg-success ms-1">Primary</span>
                                            {% endif %}
                                            {% if person.address %}
                                            <br>
                                            <small class="text-muted">{{ person.address.get_branch_category_display }}</small>
                                            {% endif %}
                                        </td>
                                        <td>{{ person.designation|default:"-" }}</td>
                                        <td>
                                            {{ person.mobile_1 }}
                                            {% if person.country_1 %}
                                            <br><small class="text-muted">{{ person.country_1 }}</small>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if person.email_company %}
                                            <a href="mailto:{{ person.email_company }}">{{ person.email_company }}</a>
                                            {% else %}-{% endif %}
                                        </td>
                                        <td>
                                            {% if person.concern_for.all %}
                                            <div class="d-flex flex-wrap gap-1">
                                                {% for concern in person.concern_for.all %}
                                                <span class="badge bg-info">{{ concern.name }}</span>
                                                {% endfor %}
                                            </div>
                                            {% else %}-{% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{% if person.is_active %}success{% else %}danger{% endif %}">
                                                {{ person.is_active|yesno:"Active,Inactive" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{% url 'cms:concern_person_update' pk=person.pk %}" 
                                                   class="btn btn-primary" title="Edit">
                                                    <i class="bi bi-pencil"></i>
                                                </a>&nbsp;
                                                <button type="button" class="btn btn-{% if person.is_active %}warning{% else %}success{% endif %} toggle-status" 
                                                        data-person-id="{{ person.pk }}" 
                                                        title="{% if person.is_active %}Deactivate{% else %}Activate{% endif %}">
                                                    <i class="bi bi-{% if person.is_active %}pause{% else %}play{% endif %}"></i>
                                                </button>&nbsp;
                                                <button type="button" class="btn btn-danger delete-concern" 
                                                        data-person-id="{{ person.pk }}" 
                                                        data-person-name="{{ person.concern_person }}"
                                                        title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-people display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No Concern Persons Added</h5>
                            <p class="text-muted">Add concern persons to manage contacts for this customer.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#quickConcernModal">
                                <i class="bi bi-person-plus me-1"></i>Add First Concern Person
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Addresses Tab -->
            <div class="tab-pane fade" id="addresses" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Customer Addresses</h4>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            <i class="bi bi-plus-circle me-1"></i>Add Address
                        </button>
                    </div>
                    <div class="card-body">
                        {% if addresses %}
                        <div class="row">
                            {% for address in addresses %}
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 {% if address.is_primary %}border-primary{% endif %}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <strong>{{ address.get_branch_category_display }}</strong>
                                        {% if address.is_primary %}
                                        <span class="badge bg-primary">Primary</span>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">{{ address.address }}</p>
                                        <div class="small text-muted">
                                            <div><strong>Location:</strong> {{ address.location }}</div>
                                            <div><strong>Pincode:</strong> {{ address.pincode }}</div>
                                            <div><strong>State:</strong> {{ address.state }}</div>
                                            <div><strong>Country:</strong> {{ address.country }}</div>
                                            {% if address.gst_number %}
                                            <div><strong>GST:</strong> {{ address.gst_number }}</div>
                                            {% endif %}
                                            {% if address.telephone %}
                                            <div><strong>Phone:</strong> {{ address.telephone }}</div>
                                            {% endif %}
                                            {% if address.email %}
                                            <div><strong>Email:</strong> {{ address.email }}</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-footer text-center">
                                        <div class="btn-group btn-group-sm ">
                                            <button type="button" class="btn btn-primary edit-address" 
                                                    data-address-id="{{ address.pk }}">
                                                <i class="bi bi-pencil"></i> Edit
                                            </button>
                                            {% if not address.is_primary %}
                                            &nbsp;
                                            <button type="button" class="btn btn-danger delete-address" 
                                                    data-address-id="{{ address.pk }}"
                                                    data-address-name="{{ address.get_branch_category_display }}">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-geo-alt display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No Addresses Added</h5>
                            <p class="text-muted">Add addresses for this customer to complete their profile.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                                <i class="bi bi-plus-circle me-1"></i>Add First Address
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Bank Details Tab -->
            <div class="tab-pane fade" id="bank-details" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Bank Accounts</h4>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addBankModal">
                            <i class="bi bi-plus-circle me-1"></i>Add Bank Account
                        </button>
                    </div>
                    <div class="card-body">
                        {% if bank_details %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Bank Name</th>
                                        <th>Account Number</th>
                                        <th>Branch Name</th>
                                        <th>IFSC Code</th>
                                        <th>Account Type</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for bank in bank_details %}
                                    <tr>
                                        <td>
                                            <strong>{{ bank.bank_name }}</strong>
                                            {% if bank.is_primary %}
                                            <span class="badge bg-primary ms-1">Primary</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ bank.account_number }}</td>
                                        <td>{{ bank.branch_name }}</td>
                                        <td>{{ bank.ifsc_code }}</td>
                                        <td>{{ bank.get_account_type_display }}</td>
                                        <td>
                                            <span class="badge bg-{% if bank.is_active %}success{% else %}danger{% endif %}">
                                                {{ bank.is_active|yesno:"Active,Inactive" }}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-primary edit-bank" 
                                                        data-bank-id="{{ bank.pk }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                {% if not bank.is_primary %}
                                                &nbsp;
                                                <button type="button" class="btn btn-danger delete-bank" 
                                                        data-bank-id="{{ bank.pk }}"
                                                        data-bank-name="{{ bank.bank_name }}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                                {% endif %}
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-bank display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No Bank Accounts Added</h5>
                            <p class="text-muted">Add bank accounts for payment processing.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBankModal">
                                <i class="bi bi-plus-circle me-1"></i>Add First Bank Account
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Documents Tab -->
            <div class="tab-pane fade" id="documents" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Customer Documents</h4>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                            <i class="bi bi-plus-circle me-1"></i>Add Document
                        </button>
                    </div>
                    <div class="card-body">
                        {% if documents %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Document Type</th>
                                        <th>Document Name</th>
                                        <th>Uploaded Date</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for document in documents %}
                                    <tr>
                                        <td>{{ document.get_document_type_display }}</td>
                                        <td>
                                            <a href="{{ document.document_file.url }}" target="_blank">
                                                {{ document.document_name }}
                                            </a>
                                        </td>
                                        <td>{{ document.uploaded_at|date:"M d, Y" }}</td>
                                        <td>
                                            {% if document.is_verified %}
                                            <span class="badge bg-success">Verified</span>
                                            {% else %}
                                            <span class="badge bg-warning text-dark">Pending</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <a href="{{ document.document_file.url }}" 
                                                   class="btn btn-primary" target="_blank" title="View">
                                                    <i class="bi bi-eye"></i>
                                                </a>&nbsp;
                                                {% if not document.is_verified %}
                                                
                                                <button type="button" class="btn btn-success verify-document" 
                                                        data-document-id="{{ document.pk }}"
                                                        title="Verify">
                                                    <i class="bi bi-check-circle"></i>
                                                </button>&nbsp;
                                                {% endif %}
                                                <button type="button" class="btn btn-danger delete-document" 
                                                        data-document-id="{{ document.pk }}"
                                                        title="Delete">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-folder display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No Documents Uploaded</h5>
                            <p class="text-muted">Upload important documents for this customer.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDocumentModal">
                                <i class="bi bi-plus-circle me-1"></i>Upload First Document
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Notes Tab -->
            <div class="tab-pane fade" id="notes" role="tabpanel">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="card-title mb-0">Customer Notes</h4>
                        <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                            <i class="bi bi-plus-circle me-1"></i>Add Note
                        </button>
                    </div>
                    <div class="card-body">
                        {% if notes %}
                        <div class="row">
                            {% for note in notes %}
                            <div class="col-12 mb-3">
                                <div class="card {% if note.is_resolved %}border-success{% else %}border-{% if note.priority == 'high' %}danger{% elif note.priority == 'medium' %}warning{% else %}info{% endif %}{% endif %}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <strong>{{ note.title }}</strong>
                                        <div>
                                            <span class="badge bg-{% if note.priority == 'high' %}danger{% elif note.priority == 'medium' %}warning{% else %}info{% endif %}">
                                                {{ note.get_priority_display }}
                                            </span>
                                            {% if note.is_resolved %}
                                            <span class="badge bg-success">Resolved</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        <p class="card-text">{{ note.content }}</p>
                                        <div class="small text-muted">
                                            Created by {{ note.created_by }} on {{ note.created_at|date:"M d, Y" }}
                                            {% if note.is_resolved %}
                                            • Resolved by {{ note.resolved_by }} on {{ note.resolved_at|date:"M d, Y" }}
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="card-footer">
                                        <div class="btn-group btn-group-sm">
                                            {% if not note.is_resolved %}
                                            <button type="button" class="btn btn-success resolve-note" 
                                                    data-note-id="{{ note.pk }}"
                                                    title="Mark as Resolved">
                                                <i class="bi bi-check-circle"></i> Resolve
                                            </button>&nbsp;
                                            {% endif %}
                                            <button type="button" class="btn btn-danger delete-note" 
                                                    data-note-id="{{ note.pk }}"
                                                    title="Delete">
                                                <i class="bi bi-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-sticky display-1 text-muted"></i>
                            <h5 class="text-muted mt-3">No Notes Added</h5>
                            <p class="text-muted">Add notes to track important information about this customer.</p>
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addNoteModal">
                                <i class="bi bi-plus-circle me-1"></i>Add First Note
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modals -->
{% include 'cms/partials/quick_concern_modal.html' %}
{% include 'cms/partials/address_modal.html' %}
{% include 'cms/partials/bank_modal.html' %}
{% include 'cms/partials/document_modal.html' %}
{% include 'cms/partials/note_modal.html' %}
{% include 'cms/partials/delete_confirmation_modal.html' %}
{% include 'cms/partials/edit_address_modal.html' %}
{% include 'cms/partials/edit_bank_modal.html' %}

<script src="{% static 'jquery/dist/jquery.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

{% if messages %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      {% for message in messages %}
        Swal.fire({
          title: "{{ message.tags|title }}",
          text: "{{ message|escapejs }}",
          icon: "{{ message.tags }}", // valid: success, error, warning, info, question
          confirmButtonText: "OK",
          background: theme === 'dark' ? '#343a40' : '#ffffff',
          color: theme === 'dark' ? '#f8f9fa' : '#212529',
          confirmButtonColor: theme === 'dark' ? '#0d6efd' : '#0d6efd',
          customClass: {
            popup: 'rounded-4 shadow',
            confirmButton: 'btn btn-primary px-4 py-2'
          }
        });
      {% endfor %}
    });
  </script>
{% endif %}

<script>
    // Concern Person Status Toggle
    document.querySelectorAll('.toggle-status').forEach(button => {
        button.addEventListener('click', function() {
            const personId = this.dataset.personId;
            
            fetch(`{% url 'cms:toggle_concern_person_status' 0 %}`.replace('0', personId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        });
    });

    // Delete Confirmation for Concern Persons
    document.querySelectorAll('.delete-concern').forEach(button => {
        button.addEventListener('click', function() {
            const personId = this.dataset.personId;
            const personName = this.dataset.personName;
            
            const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
            const modalBody = document.getElementById('deleteConfirmationBody');
            const deleteForm = document.getElementById('deleteConfirmationForm');
            
            modalBody.innerHTML = `
                <p>Are you sure you want to delete the concern person <strong>"${personName}"</strong>?</p>
                <p class="text-danger">This action cannot be undone.</p>
            `;
            
            deleteForm.action = `{% url 'cms:delete_concern_person' 0 %}`.replace('0', personId);
            
            modal.show();
        });
    });

    // Address Handlers
document.querySelectorAll('.edit-address').forEach(button => {
    button.addEventListener('click', function() {
        const addressId = this.dataset.addressId;
        const addressCard = this.closest('.card');
        
        // Extract address data from the card
        const addressData = {
            id: addressId,
            branch_category: addressCard.querySelector('[name$="branch_category"]').value,
            address: addressCard.querySelector('[name$="address"]').value,
            state: addressCard.querySelector('[name$="state"]').value,
            country: addressCard.querySelector('[name$="country"]').value,
            pincode: addressCard.querySelector('[name$="pincode"]').value,
            location: addressCard.querySelector('[name$="location"]').value,
            gst_number: addressCard.querySelector('[name$="gst_number"]').value || '',
            telephone: addressCard.querySelector('[name$="telephone"]').value || '',
            email: addressCard.querySelector('[name$="email"]').value || '',
            google_location: addressCard.querySelector('[name$="google_location"]').value || '',
            is_primary: addressCard.querySelector('[name$="is_primary"]').checked,
            is_active: addressCard.querySelector('[name$="is_active"]').checked
        };
        
        // Populate the edit form
        if (typeof populateAddressForm === 'function') {
            populateAddressForm(addressData);
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editAddressModal'));
        modal.show();
    });
});

document.querySelectorAll('.delete-address').forEach(button => {
    button.addEventListener('click', function() {
        const addressId = this.dataset.addressId;
        const addressName = this.dataset.addressName;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        const modalBody = document.getElementById('deleteConfirmationBody');
        const deleteForm = document.getElementById('deleteConfirmationForm');
        
        modalBody.innerHTML = `
            <p>Are you sure you want to delete the address <strong>"${addressName}"</strong>?</p>
            <p class="text-danger">This action cannot be undone.</p>
        `;
        
        deleteForm.action = `/cms/addresses/${addressId}/delete/`;
        
        modal.show();
    });
});

// Bank Details Handlers
document.querySelectorAll('.edit-bank').forEach(button => {
    button.addEventListener('click', function() {
        const bankId = this.dataset.bankId;
        const bankCard = this.closest('.card');
        
        // Extract bank data from the card
        const bankData = {
            id: bankId,
            bank_name: bankCard.querySelector('[name$="bank_name"]').value,
            account_number: bankCard.querySelector('[name$="account_number"]').value,
            account_type: bankCard.querySelector('[name$="account_type"]').value,
            account_holder_name: bankCard.querySelector('[name$="account_holder_name"]').value || '',
            branch_name: bankCard.querySelector('[name$="branch_name"]').value,
            ifsc_code: bankCard.querySelector('[name$="ifsc_code"]').value,
            is_primary: bankCard.querySelector('[name$="is_primary"]').checked,
            is_active: bankCard.querySelector('[name$="is_active"]').checked
        };
        
        // Populate the edit form
        if (typeof populateBankForm === 'function') {
            populateBankForm(bankData);
        }
        
        // Show the modal
        const modal = new bootstrap.Modal(document.getElementById('editBankModal'));
        modal.show();
    });
});

document.querySelectorAll('.delete-bank').forEach(button => {
    button.addEventListener('click', function() {
        const bankId = this.dataset.bankId;
        const bankName = this.dataset.bankName;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        const modalBody = document.getElementById('deleteConfirmationBody');
        const deleteForm = document.getElementById('deleteConfirmationForm');
        
        modalBody.innerHTML = `
            <p>Are you sure you want to delete the bank account for <strong>"${bankName}"</strong>?</p>
            <p class="text-danger">This action cannot be undone.</p>
        `;
        
        deleteForm.action = `/cms/bank-details/${bankId}/delete/`;
        
        modal.show();
    });
});

// Document Handlers
document.querySelectorAll('.verify-document').forEach(button => {
    button.addEventListener('click', function() {
        const documentId = this.dataset.documentId;
        
        if (confirm('Are you sure you want to mark this document as verified?')) {
            fetch(`/cms/documents/${documentId}/verify/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error verifying document.');
                }
            });
        }
    });
});

document.querySelectorAll('.delete-document').forEach(button => {
    button.addEventListener('click', function() {
        const documentId = this.dataset.documentId;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        const modalBody = document.getElementById('deleteConfirmationBody');
        const deleteForm = document.getElementById('deleteConfirmationForm');
        
        modalBody.innerHTML = `
            <p>Are you sure you want to delete this document?</p>
            <p class="text-danger">This action cannot be undone.</p>
        `;
        
        deleteForm.action = `/cms/documents/${documentId}/delete/`;
        
        modal.show();
    });
});

// Note Handlers
document.querySelectorAll('.resolve-note').forEach(button => {
    button.addEventListener('click', function() {
        const noteId = this.dataset.noteId;
        
        if (confirm('Are you sure you want to mark this note as resolved?')) {
            fetch(`/cms/notes/${noteId}/resolve/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert('Error resolving note.');
                }
            });
        }
    });
});

document.querySelectorAll('.delete-note').forEach(button => {
    button.addEventListener('click', function() {
        const noteId = this.dataset.noteId;
        
        const modal = new bootstrap.Modal(document.getElementById('deleteConfirmationModal'));
        const modalBody = document.getElementById('deleteConfirmationBody');
        const deleteForm = document.getElementById('deleteConfirmationForm');
        
        modalBody.innerHTML = `
            <p>Are you sure you want to delete this note?</p>
            <p class="text-danger">This action cannot be undone.</p>
        `;
        
        deleteForm.action = `/cms/notes/${noteId}/delete/`;
        
        modal.show();
    });
});

// Modal Form Submissions
document.addEventListener('DOMContentLoaded', function() {
    // Address Form Submission
    const addressForm = document.getElementById('addressForm');
    if (addressForm) {
        addressForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm(this, 'Address');
        });
    }

    // Bank Form Submission
    const bankForm = document.getElementById('bankForm');
    if (bankForm) {
        bankForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm(this, 'Bank details');
        });
    }

    // Document Form Submission
    const documentForm = document.getElementById('documentForm');
    if (documentForm) {
        documentForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm(this, 'Document');
        });
    }

    // Note Form Submission
    const noteForm = document.getElementById('noteForm');
    if (noteForm) {
        noteForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm(this, 'Note');
        });
    }

    // Quick Concern Form Submission
    const quickConcernForm = document.getElementById('quickConcernForm');
    if (quickConcernForm) {
        quickConcernForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitForm(this, 'Concern person');
        });
    }
});

// Generic Form Submission Function
function submitForm(form, itemType) {
    const formData = new FormData(form);
    
    fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            const modal = bootstrap.Modal.getInstance(form.closest('.modal'));
            modal.hide();
            location.reload();
        } else {
            // Display form errors
            alert(`Error adding ${itemType.toLowerCase()}. Please check the form.`);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert(`Error adding ${itemType.toLowerCase()}. Please try again.`);
    });
}

// Dynamic Modal Loading
document.addEventListener('show.bs.modal', function(event) {
    const modal = event.target;
    const modalBody = modal.querySelector('.modal-body');
    
    // Load address form
    if (modal.id === 'addAddressModal' && !modalBody.innerHTML.trim()) {
        fetch(`/cms/customers/{{ customer.pk }}/add-address/`)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
            });
    }
    
    // Load bank form
    if (modal.id === 'addBankModal' && !modalBody.innerHTML.trim()) {
        fetch(`/cms/customers/{{ customer.pk }}/add-bank/`)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
            });
    }
    
    // Load document form
    if (modal.id === 'addDocumentModal' && !modalBody.innerHTML.trim()) {
        // Document form is static, no need to load via AJAX
    }
    
    // Load note form
    if (modal.id === 'addNoteModal' && !modalBody.innerHTML.trim()) {
        // Note form is static, no need to load via AJAX
    }
});

// Real-time Validation
document.addEventListener('input', function(e) {
    // Mobile number validation
    if (e.target.name === 'mobile_1' || e.target.name === 'mobile_2') {
        e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 10);
    }
    
    // PAN validation
    if (e.target.name === 'pan_number') {
        e.target.value = e.target.value.toUpperCase();
    }
    
    // IFSC validation
    if (e.target.name === 'ifsc_code') {
        e.target.value = e.target.value.toUpperCase();
    }
    
    // GST validation
    if (e.target.name === 'gst_number') {
        e.target.value = e.target.value.toUpperCase();
    }
    
    // Phone number validation
    if (e.target.name === 'telephone' || e.target.name === 'office_phone_1' || e.target.name === 'office_phone_2') {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
    }
});

// Tab Persistence
document.addEventListener('DOMContentLoaded', function() {
    // Remember active tab
    const activeTab = localStorage.getItem('customerDetailActiveTab');
    if (activeTab) {
        const tab = document.querySelector(`[data-bs-target="${activeTab}"]`);
        if (tab) {
            new bootstrap.Tab(tab).show();
        }
    }
    
    // Save active tab on change
    document.querySelectorAll('#customerDetailTabs button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('show.bs.tab', function(event) {
            localStorage.setItem('customerDetailActiveTab', event.target.getAttribute('data-bs-target'));
        });
    });
});

// Auto-refresh for real-time updates (optional)
function startAutoRefresh() {
    setInterval(() => {
        // Only refresh if user is on customer detail page and not editing
        if (!document.querySelector('.modal.show')) {
            // You can implement partial page updates here instead of full reload
            console.log('Auto-refresh check - implement partial updates as needed');
        }
    }, 30000); // Refresh every 30 seconds
}

// Start auto-refresh if needed
// startAutoRefresh();
</script>
{% endblock %}

{% block extra_javascript %}

{% include "bootstrap/partials/syntax-highlight.html" %}

<!-- Third party js -->
<script src="{% static 'js/vendor/handlebars.min.js' %}"></script>
<script src="{% static 'js/vendor/typeahead.bundle.min.js' %}"></script>
<script src="{% static 'js/vendor/bootstrap-timepicker.min.js' %}"></script>
<!-- Third party js ends -->

<script src="{% static 'js/vendor/flatpickr.min.js' %}"></script>

<!-- Init js -->
<script src="{% static 'js/pages/demo.typehead.js' %}"></script>
<script src="{% static 'js/pages/demo.timepicker.js' %}"></script>
<!-- Init js end -->

<!-- Selectize.js JS -->
<script src="{% static 'js/selectize.min.js' %}"></script>
<script src="{% static 'js/vendor/select2.min.js' %}"></script>
{% endblock %}